<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RayVid - Video Sharing Platform</title>
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        /* Navigation */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .nav-brand h1 {
            font-size: 1.8rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-search {
            flex: 1;
            max-width: 600px;
            margin: 0 2rem;
            display: flex;
        }

        .nav-search input {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: 2px solid #667eea;
            border-radius: 50px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .nav-search input:focus {
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .nav-search button {
            margin-left: 1rem;
            padding: 0.75rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.3s ease;
        }

        .nav-search button:hover {
            transform: translateY(-2px);
        }

        .nav-auth {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: 500;
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            padding: 0.5rem 1rem;
            border-radius: 50px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #667eea;
        }

        .auth-button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .sign-in {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sign-in:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .sign-out {
            background: #ff4757;
            color: white;
        }

        .sign-out:hover {
            background: #ff3742;
            transform: translateY(-2px);
        }

        .admin-link {
            background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .admin-link:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        /* Main Container */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        /* Content Area */
        .content-area {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        /* Upload Section */
        .upload-section {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .upload-section h2 {
            color: #667eea;
            margin-bottom: 1.5rem;
            font-size: 1.8rem;
        }

        .upload-form {
            display: grid;
            gap: 1.25rem;
        }

        .upload-form input,
        .upload-form textarea {
            padding: 1rem 1.5rem;
            border: 2px solid #e0e6ff;
            border-radius: 12px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .upload-form input:focus,
        .upload-form textarea:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        .upload-form textarea {
            min-height: 120px;
            resize: vertical;
        }

        .upload-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.25rem;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 20px rgba(102, 126, 234, 0.4);
        }

        /* Videos Grid */
        .videos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 2rem;
            margin-top: 2rem;
        }

        .video-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border: 1px solid #e0e6ff;
        }

        .video-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }

        .video-thumbnail {
            position: relative;
            height: 200px;
            overflow: hidden;
        }

        .video-thumbnail iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .video-thumbnail .placeholder {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .video-info {
            padding: 1.5rem;
        }

        .video-info h3 {
            color: #333;
            margin-bottom: 0.75rem;
            font-size: 1.3rem;
            line-height: 1.4;
        }

        .video-info p {
            color: #666;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .video-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #888;
            font-size: 0.9rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e6ff;
        }

        .uploader-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .uploader-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Sidebar */
        .sidebar {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            height: fit-content;
        }

        .ad-section {
            background: linear-gradient(135deg, #f8f9ff 0%, #e8edff 100%);
            border-radius: 15px;
            padding: 1.5rem;
            text-align: center;
            margin-bottom: 2rem;
        }

        .ad-placeholder {
            padding: 2rem;
            background: linear-gradient(45deg, #f0f0f0 25%, #e8e8e8 25%, #e8e8e8 50%, #f0f0f0 50%, #f0f0f0 75%, #e8e8e8 75%);
            background-size: 100px 100px;
            border-radius: 10px;
            color: #999;
            font-weight: bold;
            border: 2px dashed #667eea;
        }

        .profile-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 1.5rem;
            color: white;
            text-align: center;
        }

        .profile-section h3 {
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid white;
            margin: 0 auto 1rem;
            display: block;
        }

        .profile-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.75rem;
            border-radius: 10px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 2.5rem;
            width: 90%;
            max-width: 500px;
            position: relative;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-modal {
            position: absolute;
            right: 1.5rem;
            top: 1.5rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
            background: none;
            border: none;
        }

        .close-modal:hover {
            color: #ff4757;
        }

        /* Loading Spinner */
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                grid-row: 1;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }
            
            .nav-search {
                width: 100%;
                margin: 0;
            }
            
            .videos-grid {
                grid-template-columns: 1fr;
            }
            
            .main-container {
                padding: 1rem;
            }
            
            .content-area, .sidebar {
                padding: 1.5rem;
            }
        }

        /* Notification */
        .notification {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem 1.5rem;
            background: #4CAF50;
            color: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            display: none;
            z-index: 3000;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.error {
            background: #ff4757;
        }

        .notification.warning {
            background: #ffa502;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-brand">
            <h1>üìπ RayVid</h1>
        </div>
        <div class="nav-search">
            <input type="text" id="searchInput" placeholder="Search videos, creators, tags...">
            <button onclick="searchVideos()">üîç Search</button>
        </div>
        <div class="nav-auth">
            <div class="user-info" id="userInfo">
                <span>üë§ Guest</span>
            </div>
            <button class="auth-button sign-in" onclick="signInWithGoogle()">
                Sign in with Google
            </button>
            <button class="auth-button sign-out" onclick="signOut()" style="display: none;">
                Sign Out
            </button>
            <a href="admin.html" class="admin-link">Admin Dashboard</a>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Main Content -->
        <div class="content-area">
            <!-- Upload Section -->
            <div class="upload-section" id="uploadSection" style="display: none;">
                <h2>üé• Share Your Video</h2>
                <div class="upload-form">
                    <input type="text" id="videoTitle" placeholder="Video Title *" required>
                    <textarea id="videoDescription" placeholder="Video Description"></textarea>
                    <input type="url" id="videoUrl" placeholder="Google Drive or YouTube URL *" required>
                    <input type="text" id="videoTags" placeholder="Tags (comma separated)">
                    <button onclick="uploadVideo()" class="upload-btn">üì§ Upload Video</button>
                </div>
            </div>

            <!-- Videos Section -->
            <div class="videos-section">
                <h2 style="color: #667eea; margin-bottom: 1.5rem;">üé¨ Featured Videos</h2>
                <div class="videos-grid" id="videosGrid">
                    <!-- Videos will be loaded here -->
                    <div class="spinner" id="loadingSpinner"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Ad Section -->
            <div class="ad-section">
                <h3 style="color: #667eea; margin-bottom: 1rem;">üì¢ Advertisement</h3>
                <div id="adContainer" class="ad-placeholder">
                    Ads loading...
                </div>
            </div>

            <!-- Profile Section -->
            <div class="profile-section" id="profileSection" style="display: none;">
                <h3>üë§ Your Profile</h3>
                <img id="profileAvatar" src="" alt="Profile" class="profile-avatar">
                <h4 id="profileName">User Name</h4>
                <p id="profileEmail" style="opacity: 0.9; margin-bottom: 1rem;">user@email.com</p>
                <div class="profile-stats">
                    <div class="stat">
                        <span class="stat-value" id="videosCount">0</span>
                        <span class="stat-label">Videos</span>
                    </div>
                    <div class="stat">
                        <span class="stat-value" id="likesCount">0</span>
                        <span class="stat-label">Likes</span>
                    </div>
                </div>
                <button onclick="showUploadSection()" style="margin-top: 1rem; width: 100%; padding: 0.75rem; background: white; color: #667eea; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                    üìπ Upload New Video
                </button>
            </div>

            <!-- Guest Message -->
            <div class="profile-section" id="guestSection">
                <h3>üëã Welcome to RayVid!</h3>
                <p style="margin-bottom: 1rem; opacity: 0.9;">Sign in to upload videos, like content, and create your profile.</p>
                <button onclick="signInWithGoogle()" style="width: 100%; padding: 0.75rem; background: white; color: #667eea; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-bottom: 0.5rem;">
                    Sign in with Google
                </button>
                <p style="font-size: 0.9rem; opacity: 0.8;">Join our community of creators!</p>
            </div>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="modal" id="videoModal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="close-modal" onclick="closeVideoModal()">&times;</button>
            <div id="videoPlayer" style="width: 100%; height: 400px; background: #000; border-radius: 10px; margin-bottom: 1rem;"></div>
            <h3 id="modalTitle" style="color: #333;"></h3>
            <p id="modalDescription" style="color: #666; margin: 1rem 0;"></p>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div class="uploader-info">
                    <img id="modalAvatar" src="" alt="Uploader" class="uploader-avatar">
                    <span id="modalUploader" style="font-weight: 500;"></span>
                </div>
                <button onclick="likeVideo()" id="likeButton" style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer;">
                    ‚ù§Ô∏è Like (<span id="likeCount">0</span>)
                </button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <!-- Firebase and App Script -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-analytics-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAoZdkD0PZz25lIVrNy3hQE2fBrkHELs2Q",
            authDomain: "rayvid-c074a.firebaseapp.com",
            projectId: "rayvid-c074a",
            storageBucket: "rayvid-c074a.firebasestorage.app",
            messagingSenderId: "970771885312",
            appId: "1:970771885312:web:104ae741f28287a01ad7e5",
            measurementId: "G-LDBSZRRPQL"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        const analytics = firebase.analytics();

        // Global Variables
        let currentUser = null;
        let currentVideoId = null;

        // Auth Functions
        const provider = new firebase.auth.GoogleAuthProvider();

        async function signInWithGoogle() {
            try {
                const result = await auth.signInWithPopup(provider);
                currentUser = result.user;
                
                // Save user to Firestore
                await db.collection('users').doc(currentUser.uid).set({
                    uid: currentUser.uid,
                    displayName: currentUser.displayName,
                    email: currentUser.email,
                    photoURL: currentUser.photoURL,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    role: 'user',
                    videosCount: 0,
                    likesCount: 0
                }, { merge: true });
                
                showNotification('Successfully signed in!', 'success');
            } catch (error) {
                console.error("Google Sign-In Error:", error);
                showNotification('Sign in failed. Please try again.', 'error');
            }
        }

        function signOut() {
            auth.signOut().then(() => {
                showNotification('Successfully signed out!', 'success');
            }).catch(error => {
                showNotification('Sign out failed.', 'error');
            });
        }

        // Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            currentUser = user;
            if (user) {
                // User is signed in
                document.getElementById('userInfo').innerHTML = `
                    <img src="${user.photoURL}" alt="${user.displayName}" class="user-avatar">
                    <span>${user.displayName}</span>
                `;
                document.querySelector('.sign-in').style.display = 'none';
                document.querySelector('.sign-out').style.display = 'block';
                document.getElementById('uploadSection').style.display = 'block';
                document.getElementById('profileSection').style.display = 'block';
                document.getElementById('guestSection').style.display = 'none';
                
                // Load user profile
                await loadUserProfile(user.uid);
            } else {
                // User is signed out
                document.getElementById('userInfo').innerHTML = '<span>üë§ Guest</span>';
                document.querySelector('.sign-in').style.display = 'block';
                document.querySelector('.sign-out').style.display = 'none';
                document.getElementById('uploadSection').style.display = 'none';
                document.getElementById('profileSection').style.display = 'none';
                document.getElementById('guestSection').style.display = 'block';
            }
            loadVideos();
            loadAds();
        });

        // Video Functions
        async function loadVideos() {
            const videosGrid = document.getElementById('videosGrid');
            const spinner = document.getElementById('loadingSpinner');
            
            try {
                const snapshot = await db.collection('videos')
                    .where('approved', '==', true)
                    .orderBy('uploadedAt', 'desc')
                    .limit(20)
                    .get();
                
                videosGrid.innerHTML = '';
                
                if (snapshot.empty) {
                    videosGrid.innerHTML = `
                        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #666;">
                            <h3>No videos yet</h3>
                            <p>Be the first to upload a video!</p>
                        </div>
                    `;
                    return;
                }
                
                snapshot.forEach(doc => {
                    const video = doc.data();
                    const videoElement = createVideoCard(doc.id, video);
                    videosGrid.appendChild(videoElement);
                });
            } catch (error) {
                console.error("Error loading videos:", error);
                videosGrid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #ff4757;">
                        <h3>Error loading videos</h3>
                        <p>Please try again later</p>
                    </div>
                `;
            } finally {
                spinner.style.display = 'none';
            }
        }

        function createVideoCard(videoId, video) {
            const div = document.createElement('div');
            div.className = 'video-card';
            div.onclick = () => openVideoModal(videoId, video);
            
            const thumbnail = getVideoThumbnail(video.url);
            const views = video.views || 0;
            const likes = video.likes || 0;
            
            div.innerHTML = `
                <div class="video-thumbnail">
                    ${thumbnail}
                </div>
                <div class="video-info">
                    <h3>${video.title}</h3>
                    <p>${video.description ? video.description.substring(0, 100) + '...' : 'No description'}</p>
                    <div class="video-meta">
                        <div class="uploader-info">
                            <img src="${video.uploaderPhoto || ''}" alt="${video.uploaderName}" class="uploader-avatar">
                            <span>${video.uploaderName}</span>
                        </div>
                        <div>
                            <span>üëÅÔ∏è ${views} | ‚ù§Ô∏è ${likes}</span>
                        </div>
                    </div>
                </div>
            `;
            return div;
        }

        function getVideoThumbnail(url) {
            if (url.includes('drive.google.com')) {
                const fileId = url.match(/\/d\/(.+?)\//)?.[1] || url.match(/id=(.+?)(&|$)/)?.[1];
                if (fileId) {
                    return `<iframe src="https://drive.google.com/file/d/${fileId}/preview" allowfullscreen></iframe>`;
                }
            } else if (url.includes('youtube.com') || url.includes('youtu.be')) {
                const videoId = url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/)?.[1];
                if (videoId) {
                    return `<iframe src="https://www.youtube.com/embed/${videoId}" allowfullscreen></iframe>`;
                }
            }
            return '<div class="placeholder">üé¨ Video Preview</div>';
        }

        async function uploadVideo() {
            if (!currentUser) {
                showNotification('Please sign in to upload videos', 'warning');
                return;
            }
            
            const title = document.getElementById('videoTitle').value.trim();
            const description = document.getElementById('videoDescription').value.trim();
            const url = document.getElementById('videoUrl').value.trim();
            const tags = document.getElementById('videoTags').value.split(',').map(tag => tag.trim()).filter(tag => tag);
            
            if (!title || !url) {
                showNotification('Please fill in title and URL', 'warning');
                return;
            }
            
            try {
                const videoData = {
                    title,
                    description,
                    url,
                    tags,
                    uploaderId: currentUser.uid,
                    uploaderName: currentUser.displayName,
                    uploaderPhoto: currentUser.photoURL,
                    uploadedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    views: 0,
                    likes: 0,
                    likedBy: [],
                    approved: false
                };
                
                await db.collection('videos').add(videoData);
                
                // Update user's video count
                await db.collection('users').doc(currentUser.uid).update({
                    videosCount: firebase.firestore.FieldValue.increment(1)
                });
                
                showNotification('Video uploaded! Waiting for admin approval.', 'success');
                clearUploadForm();
                loadUserProfile(currentUser.uid);
            } catch (error) {
                console.error("Upload error:", error);
                showNotification('Error uploading video', 'error');
            }
        }

        function clearUploadForm() {
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            document.getElementById('videoUrl').value = '';
            document.getElementById('videoTags').value = '';
        }

        // Modal Functions
        function openVideoModal(videoId, video) {
            currentVideoId = videoId;
            const modal = document.getElementById('videoModal');
            const player = document.getElementById('videoPlayer');
            
            // Update video info
            document.getElementById('modalTitle').textContent = video.title;
            document.getElementById('modalDescription').textContent = video.description || 'No description';
            document.getElementById('modalUploader').textContent = video.uploaderName;
            document.getElementById('modalAvatar').src = video.uploaderPhoto || '';
            document.getElementById('likeCount').textContent = video.likes || 0;
            
            // Update like button
            const liked = video.likedBy?.includes(currentUser?.uid);
            document.getElementById('likeButton').innerHTML = 
                `${liked ? 'üíî' : '‚ù§Ô∏è'} Like (${video.likes || 0})`;
            
            // Embed video
            if (video.url.includes('drive.google.com')) {
                const fileId = video.url.match(/\/d\/(.+?)\//)?.[1] || video.url.match(/id=(.+?)(&|$)/)?.[1];
                player.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" width="100%" height="100%" allowfullscreen></iframe>`;
            } else if (video.url.includes('youtube.com') || video.url.includes('youtu.be')) {
                const videoId = video.url.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([^&\n?#]+)/)?.[1];
                player.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}" width="100%" height="100%" allowfullscreen></iframe>`;
            } else {
                player.innerHTML = `<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: white; font-size: 1.2rem;">üé¨ Video Player</div>`;
            }
            
            modal.style.display = 'flex';
            
            // Increment view count
            if (currentUser && !video.viewedBy?.includes(currentUser.uid)) {
                db.collection('videos').doc(videoId).update({
                    views: firebase.firestore.FieldValue.increment(1),
                    viewedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                });
            }
        }

        function closeVideoModal() {
            document.getElementById('videoModal').style.display = 'none';
            document.getElementById('videoPlayer').innerHTML = '';
        }

        async function likeVideo() {
            if (!currentUser) {
                showNotification('Please sign in to like videos', 'warning');
                return;
            }
            
            try {
                const videoRef = db.collection('videos').doc(currentVideoId);
                const videoDoc = await videoRef.get();
                const video = videoDoc.data();
                const liked = video.likedBy?.includes(currentUser.uid);
                
                if (liked) {
                    // Unlike
                    await videoRef.update({
                        likes: firebase.firestore.FieldValue.increment(-1),
                        likedBy: firebase.firestore.FieldValue.arrayRemove(currentUser.uid)
                    });
                    document.getElementById('likeButton').innerHTML = `‚ù§Ô∏è Like (${video.likes - 1})`;
                } else {
                    // Like
                    await videoRef.update({
                        likes: firebase.firestore.FieldValue.increment(1),
                        likedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid)
                    });
                    document.getElementById('likeButton').innerHTML = `üíî Unlike (${video.likes + 1})`;
                }
            } catch (error) {
                console.error("Like error:", error);
                showNotification('Error updating like', 'error');
            }
        }

        // Ad Functions
        async function loadAds() {
            try {
                const adDoc = await db.collection('settings').doc('ads').get();
                if (adDoc.exists) {
                    const ads = adDoc.data();
                    const adContainer = document.getElementById('adContainer');
                    
                    if (ads.enabled && ads.code) {
                        adContainer.innerHTML = ads.code;
                    } else {
                        adContainer.innerHTML = '<div class="ad-placeholder">Ad Space Available</div>';
                    }
                }
            } catch (error) {
                console.error("Error loading ads:", error);
            }
        }

        // Profile Functions
        async function loadUserProfile(userId) {
            try {
                const userDoc = await db.collection('users').doc(userId).get();
                if (userDoc.exists) {
                    const user = userDoc.data();
                    
                    document.getElementById('profileAvatar').src = user.photoURL;
                    document.getElementById('profileName').textContent = user.displayName;
                    document.getElementById('profileEmail').textContent = user.email;
                    document.getElementById('videosCount').textContent = user.videosCount || 0;
                    document.getElementById('likesCount').textContent = user.likesCount || 0;
                }
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }

        function showUploadSection() {
            document.getElementById('uploadSection').scrollIntoView({ behavior: 'smooth' });
        }

        // Utility Functions
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        function searchVideos() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            if (searchTerm) {
                showNotification(`Searching for: ${searchTerm}`, 'warning');
                // Implement search functionality
            }
        }

        // Initialize on load
        window.onload = function() {
            analytics.logEvent('page_view');
        };

        // Close modal on ESC key
        document.onkeydown = function(evt) {
            evt = evt || window.event;
            if (evt.keyCode === 27) {
                closeVideoModal();
            }
        };
    </script>
</body>
</html>
